<template>
    <div class="outlets">
        <!-- When page is loading -->
        <template lwc:if={isLoading}>
            <c-on-loading-screen></c-on-loading-screen>
        </template>
        <!--once Page Loaded-->
        <template lwc:else>
            <div class="dropdown">
                <div class="dropdown-head">
                    <div class="dropdown-head-left">
                        <h4 class="dropdown-head-title">Expense Details</h4>
                    </div>
                </div>
                <div class="task-head-button">
                    <div class="task-button pointer" data-name="Add" onclick={handleOnclickMenu}>
                        Add Expense</div>
                </div>
                <template lwc:if={showExpenseItems}>
                    <template lwc:if={expenseDataExisted}>
                        <div class="route">
                            <template for:each={expItems} for:item="item" for:index="index">
                                <div class="competiton-body" key={item.Id}>
                                    <div class="borderLine">
                                        <div  class="route-outlet" >
                                            <div class="route-left pointer" data-id={item.Id} onclick={openPopupDetails}>
                                                <div class="outlet-row">
                                                    <span class="outlet-label">Expense Date</span>
                                                    <span>:</span>
                                                    <span class="outlet-value">{item.Expense_Date__c}</span>
                                                </div>
                                                <div class="outlet-row">
                                                    <span class="outlet-label">Allowance Type</span>
                                                    <span>:</span>
                                                    <span class="outlet-value">{item.Allowance_Type__c}</span>
                                                </div>
                                                <div class="outlet-row">
                                                    <span class="outlet-label">Amount</span>
                                                    <span>:</span>
                                                    <span class="outlet-value">{item.Amount__c}</span>
                                                </div>
                                        
                                            </div>
                                            
                                            <!--More-->
                                            <div class="right"  >
                                                <svg class="outlet-icon" width="24" data-id={item.id} data-index={index}  onclick={openMenu} height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M12 5.92C12.2546 5.92 12.4988 5.81886 12.6789 5.63882C12.8589 5.45879 12.96 5.21461 12.96 4.96C12.96 4.70539 12.8589 4.46121 12.6789 4.28118C12.4988 4.10114 12.2546 4 12 4C11.7454 4 11.5013 4.10114 11.3212 4.28118C11.1412 4.46121 11.04 4.70539 11.04 4.96C11.04 5.21461 11.1412 5.45879 11.3212 5.63882C11.5013 5.81886 11.7454 5.92 12 5.92ZM12 12.96C12.2546 12.96 12.4988 12.8589 12.6789 12.6788C12.8589 12.4988 12.96 12.2546 12.96 12C12.96 11.7454 12.8589 11.5012 12.6789 11.3212C12.4988 11.1411 12.2546 11.04 12 11.04C11.7454 11.04 11.5013 11.1411 11.3212 11.3212C11.1412 11.5012 11.04 11.7454 11.04 12C11.04 12.2546 11.1412 12.4988 11.3212 12.6788C11.5013 12.8589 11.7454 12.96 12 12.96ZM12 20C12.2546 20 12.4988 19.8989 12.6789 19.7188C12.8589 19.5388 12.96 19.2946 12.96 19.04C12.96 18.7854 12.8589 18.5412 12.6789 18.3612C12.4988 18.1811 12.2546 18.08 12 18.08C11.7454 18.08 11.5013 18.1811 11.3212 18.3612C11.1412 18.5412 11.04 18.7854 11.04 19.04C11.04 19.2946 11.1412 19.5388 11.3212 19.7188C11.5013 19.8989 11.7454 20 12 20Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                                <!-- Popup menu -->
                                                <template lwc:if={item.openPopup}>
                                                    <div class="popup" id={index}>
                                                        <ul>
                                                            <li onclick={handleOnclickMenu} data-name="Add" data-id={item.id} data-index={index}>
                                                                <i class="material-symbols-outlined">
                                                                    <lightning-icon 
                                                                            icon-name="utility:add" 
                                                                            size="x-small" 
                                                                            alternative-text="Add"
                                                                            class="invert-image" 
                                                                            ></lightning-icon>
                                                                </i>
                                                                Add
                                                            </li>
                                                            <li onclick={handleOnclickMenu} data-name="Edit" data-id={item.id} data-index={index}>
                                                                <i class="material-icons">
                                                                    <lightning-icon 
                                                                                    icon-name="utility:edit" 
                                                                                    size="x-small" 
                                                                                    alternative-text="Edit"
                                                                                    class="invert-image"
                                                                                    >
                                                                    </lightning-icon>
                                                                </i>
                                                                Edit
                                                            </li > 
                                                        <li onclick={handleOnclickMenu} data-name="Delete" data-id={item.id} data-index={index}>
                                                                <i class="material-icons">
                                                                    <lightning-icon 
                                                                                    icon-name="utility:delete" 
                                                                                    size="x-small" 
                                                                                    alternative-text="Delete"
                                                                                    class="invert-image"
                                                                                    >
                                                                    </lightning-icon>
                                                                </i>
                                                                Delete
                                                            </li >                              
                                                        </ul>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template> 
                            
                        </div>
                    </template>
                </template>
                
            </div>
            <!-- Popup Modal -->
            <template lwc:if={showPopup}>
                <div class="popup-overlay">
                    <div class="popup-content">
                        <h3><b>Expense Details</b></h3>
                        <!--Expense Date-->
                        <div class="popup-row">
                            <span class="popup-label">Expense Date</span>
                            <span>:</span>
                            <span class="popup-value">{selectedItem.Expense_Date__c}</span>
                        </div>
                        <!--Expense Type-->
                        <div class="popup-row">
                            <span class="popup-label">Expense Type</span>
                            <span>:</span>
                            <span class="popup-value">{selectedItem.Expense_Type__c}</span>
                        </div>
                        <!--From-->
                        <div class="popup-row">
                            <span class="popup-label">From</span>
                            <span>:</span>
                            <span class="popup-value">{selectedItem.City__c}</span>
                        </div>
                        <!--To-->
                        <div class="popup-row">
                            <span class="popup-label">To</span>
                            <span>:</span>
                            <span class="popup-value">{selectedItem.Area_Name__c}</span>
                        </div>
                        <!--Allowance Type-->
                        <div class="popup-row">
                            <span class="popup-label">Allowance Type</span>
                            <span>:</span>
                            <span class="popup-value">{selectedItem.Allowance_Type__c}</span>
                        </div>
                        <!--Mode of Transport-->
                        <template if:true={selectedItem.isTA}>
                            <div class="popup-row">
                                <span class="popup-label">Mode. Transport</span>
                                <span>:</span>
                                <span class="popup-value">{selectedItem.Mode_of_transport__c}</span>
                            </div>
                        </template>
                        <!--Distance Travelled And Sysem Km-->
                        <template if:true={selectedItem.isTransportCarBike}>
                            <div class="popup-row">
                                <span class="popup-label">Distance Travelled</span>
                                <span>:</span>
                                <span class="popup-value">{selectedItem.Total_KM__c}</span>
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">System Distance</span>
                                <span>:</span>
                                <span class="popup-value">{selectedItem.Calculated_KM__c}</span>
                            </div>
                        </template>
                        <!--Amount-->
                        <div class="popup-row">
                            <span class="popup-label">Amount</span>
                            <span>:</span>
                            <span class="popup-value">{selectedItem.Amount__c}</span>
                        </div>
                        <!--Companion-->
                        <template if:true={selectedItem.isCompanionExisted}>
                            <div class="popup-row">
                                <span class="popup-label">Companion Name</span>
                                <span>:</span>
                                <span class="popup-value">{selectedItem.Colleague_Name_2__c}</span>
                            </div>
                        </template>
                        <!--Description-->
                        <div class="popup-row">
                            <span class="popup-label">Description</span>
                            <span>:</span>
                            <span class="popup-value">{selectedItem.Description__c}</span>
                        </div>
                
                        <button class="close-btn" onclick={closePopup}>Close</button>
                    </div>
                </div>
            </template>
            <!-- Edit/Add Expense Popup -->
            <template if:true={isModalOpen}>
                <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
                    <div class={containerClass}>
                        <template lwc:if={isDesktop}>
                            <template if:false={showUpload}>
                                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" onclick={closeModal}>
                                    <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                                    <span class="slds-assistive-text">Close</span>
                                </button>
                            </template>
                        </template>
                        <!-- Modal/Popup Header -->
                        <header class="slds-modal__header">
                            <div class="slds-grid slds-gutters">
                                <template if:false={isDesktop}>
                                    <div class="slds-col  slds-clearfix">
                                        <div class="slds-float_right">
                                            <template if:false={showUpload}>
                                                <lightning-button variant="base" label="Cancel"  onclick={closeModal} class="slds-m-left_x-small"></lightning-button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                <div class="slds-col slds-align_absolute-center">
                                    <h1 id="modal-heading-02" class="slds-modal__title slds-hyphenate small-modal-title" tabindex="-1">{modalTitle}</h1>
                                </div>
                                <template if:false={isDesktop}>
                                    <div class="slds-col  slds-clearfix">
                                        <div class="slds-float_left">
                                            <template if:false={showUpload}>
                                                <lightning-button variant="base" label="Save &amp; Next"  onclick={save} class="slds-m-left_x-small"></lightning-button>
                                            </template>
                                            <template if:true={showUpload}>
                                                <lightning-button variant="base" label="Done"  onclick={save} class="slds-m-left_x-small"></lightning-button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </header>

                        <!-- Modal Body -->
                        <div class="slds-modal__content slds-p-around_medium">
                            <div class="slds-grid slds-wrap slds-grid_pull-padded-x-small"> 
                                <!-- Expense Date -->
                                <div class={customClass}>
                                    <lightning-input 
                                        label="Expense Date"
                                        data-id="Expense_Date"
                                        value={expenseItem.Expense_Date__c}
                                        min={expense.Expense_From_Date__c}
                                        max={expense.Expense_To_Date__c}
                                        type="date"
                                        required ="true"
                                        message-when-value-missing="Please Enter Date"
                                        disabled={isDisabled}
                                        onchange={validateLog}>
                                    </lightning-input>
                                </div>
                                <!-- Expense Type -->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Expense Type"
                                        value={expenseItem.Expense_Type__c}
                                        options={expenseOptions}
                                        message-when-value-missing="Select Expense Type"
                                        disabled ="true">
                                    </lightning-combobox>
                                </div>
                                <!-- From Location -->
                                <div class={customClass}>
                                    <lightning-input 
                                        label="From" 
                                        data-id="City"
                                        type="text" 
                                        value={expenseItem.City__c} 
                                        data-index={index}
                                        onchange={handlerInputChange}
                                        required
                                        message-when-value-missing="Please enter from location"
                                        disabled={isDisabled}>
                                    </lightning-input>
                                </div>
                                <!-- To Location -->
                                <div class={customClass}>
                                    <lightning-input 
                                        label="To" 
                                        type="text" 
                                        data-id="Area_Name"
                                        onchange={handlerInputChange}
                                        value={expenseItem.Area_Name__c} 
                                        message-when-value-missing="Please enter to location"
                                        disabled={isDisabled}>
                                    </lightning-input>
                                </div>
                                <!-- Allowance Type -->
                                <div class={customClass}>
                                    <lightning-combobox
                                    label="Allowance Type"
                                    value={expenseItem.Allowance_Type__c}
                                    options={allowanceOptions}
                                    required
                                    data-id="Allowance_Type"
                                    dropdown-alignment="top"
                                    message-when-value-missing="Select Allowance Type"
                                    onchange={allowanceTypeChangeHandler}
                                    disabled={expenseItem.allownceDisabled}>
                                </lightning-combobox>
                                </div>
                                <!-- Mode Of Transport-->
                                <template if:true={expenseItem.isTA}>
                                    <div class={customClass}>
                                        <lightning-combobox
                                            label="Mode of Transport"
                                            value={expenseItem.Mode_of_transport__c}
                                            data-id="Mode_of_transport"
                                            options={transportOptions}
                                            required
                                            dropdown-alignment="top"
                                            message-when-value-missing="Select Mode of Transport"
                                            onchange={modeOfTransportChangeHandler}
                                            disabled={isDisabled}>
                                        </lightning-combobox>
                                    </div>
                                </template>
                                <!-- mode of transport Car/Bike -->
                                <template if:true={expenseItem.isTransportCarBike}>
                                    <!--Distance Travledd-->
                                    <div class={customClass}>
                                        <lightning-input 
                                            label="Distance Travelled"
                                            type="number"
                                            data-id="Total_KM"
                                            value={expenseItem.Total_KM__c}
                                            required ="true"
                                            message-when-value-missing="Enter total distance travelled"
                                            onchange={modeOfTransportChangeHandler}
                                            disabled={isDisabled}>
                                        </lightning-input>
                                    </div>
                                    <!--Amount-->
                                    <div class={customClass}>
                                        <lightning-input 
                                            label="Amount"
                                            type="number"
                                            value={expenseItem.Amount__c}
                                            formatter="currency"
                                            step="0.01" 
                                            onchange={handlerInputChange}
                                            disabled="true">
                                        </lightning-input>
                                    </div>
                                    <!--System Calculated KM-->
                                    <div class={customClass}>
                                        <lightning-input 
                                            label="System Calculated Distance"
                                            type="number"
                                            value={expenseItem.Calculated_KM__c}
                                            disabled="true">
                                        </lightning-input>
                                    </div>
                                </template>
                                <!-- mode of transport Not Car/Bike -->
                                <template if:true={expenseItem.isTransportNotBikeCar}>
                                    <div class={customClass}>
                                        <lightning-input 
                                            label="Amount"
                                            data-id="Amount"
                                            type="number"
                                            required="true"
                                            onchange={handlerInputChange}
                                            value={expenseItem.Amount__c}
                                            message-when-value-missing="Please enter amount"
                                            formatter="currency"
                                            step="0.01"
                                            disabled={isDisabled}>
                                        </lightning-input>
                                    </div>
                                </template>
                                <!-- DA Type -->
                                <template if:true={expenseItem.isDA}>
                                    <div class={customClass}>
                                        <lightning-input 
                                            label="Amount"
                                            type="number"
                                            value={expenseItem.Amount__c}
                                            formatter="currency"
                                            step="0.01"
                                            disabled="true">
                                        </lightning-input>
                                    </div>
                                </template>
                                <!-- Other Allowance -->
                                <template if:true={expenseItem.isOtherExpense}>
                                    <div class={customClass}>
                                        <lightning-input 
                                            label="Amount"
                                            data-id="Amount"
                                            type="number"
                                            value={expenseItem.Amount__c}
                                            formatter="currency"
                                            step="0.01"
                                            onchange={handlerInputChange}
                                            required ="true"
                                            message-when-value-missing="Please enter amount"
                                            disabled={isDisabled}>
                                        </lightning-input>
                                    </div>
                                </template>
                                <!-- Companion Name -->
                                <template if:true={expenseItem.isCompanionExisted}>
                                    <div class={customClass}>
                                        <lightning-input 
                                            label="Companion Name"
                                            type="text"
                                            value={expenseItem.Colleague_Name_2__c}
                                            disabled ="true">
                                        </lightning-input>
                                    </div>
                                </template>
                                <!-- Description -->
                                <div class="slds-size_1-of-1 slds-p-horizontal_small">
                                    <lightning-textarea 
                                        name="Description"
                                        data-id="Description"
                                        value={expenseItem.Description__c}
                                        label="Description"
                                        message-when-value-missing=" Please enter description"
                                        onchange={handlerInputChange}
                                        disabled={isDisabled}>
                                    </lightning-textarea>
                                </div>
                                <!--File Upload-->
                                <template if:true={showUpload}>
                                    <div class="slds-size_1-of-1 slds-p-horizontal_small">
                                        <br/>
                                        <c-file-upload-l-w-c record-id={expenseItem.Id}></c-file-upload-l-w-c>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <template lwc:if={isDesktop}>
                            <footer class="slds-modal__footer">
                                
                                <template if:false={showUpload}>
                                    <button class="slds-button slds-button_neutral" onclick={closeModal}>Cancel</button>
                                    <button class="slds-button slds-button_brand" onclick={save}>Save &amp; Next</button>
                                </template>
                                <template if:true={showUpload}>
                                    <button class="slds-button slds-button_brand" onclick={save}>Done</button>
                                </template>
                            </footer>
                        </template>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </template>
                    
            <!-- Delete Confirmation Modal -->
            <template if:true={isDeleteModalOpen}>
                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container">
                        <header class="slds-modal__header" style="color: black;">
                            <h2 id="modal-heading-01" class="slds-modal__title slds-hyphenate">Delete Expense</h2>
                        </header>
                        
                        <div class="slds-modal__content slds-p-around_medium centeralign" >
                            Are you sure you want to delete this expense?
                        </div>
                        
                        <!-- Modal Footer -->
                        <footer class="slds-modal__footer">
                            <button class="slds-button slds-button_neutral" onclick={handleDeleteCancel}>No</button>
                            <button class="slds-button slds-button_brand" onclick={deleteExpense}>Yes</button>
                        </footer>
                    
                    </div>
                </section>
                    <div class="slds-backdrop slds-backdrop_open"></div>
            </template>

        </template>
    </div>

</template>