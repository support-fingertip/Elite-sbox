<template>
    <div class="outlets">
        <!-- When page is loading -->
        <template lwc:if={isLoading}>
            <c-on-loading-screen></c-on-loading-screen>
        </template>
        <!--once Page Loaded-->
        <template lwc:else>
            <!--View Form-->
            <template if:false={isDeleteModalOpen}>
                <template if:false={isModalOpen}>
                    <div class="dropdown">
                        <!--When user is not in deactivate stage we are showing assign buttton-->
                        <template if:false={isUserDeactivated}>
                            <template lwc:if={assignPrimaryCustomers}>
                                <div class="task-head-button">
                                    <div class="task-button pointer" data-name="Add" onclick={handleOnclickMenu}>
                                        Assign Primary Customer
                                    </div>
                                </div>
                            </template>
                        </template>
                        <template lwc:if={showItems}>
                            <div class="route">
                                <lightning-input 
                                    type="search" 
                                    placeholder="Search by Customer Name, Primary Code, or Customer Code"
                                    value={searchKey} 
                                    onchange={handleSearch}
                                    class="slds-input_bare slds-border_none textField">
                                </lightning-input>

                                <template for:each={uniquePrimaryCustomers} for:item="item" for:index="index">
                                    <div class="competiton-body" key={item.id}>
                                        <div class="borderLine">
                                            <div  class="route-outlet" >
                                                <div class="route-left" data-id={item.Id}>
                                                    <div class="outlet-row">
                                                        <span class="outlet-label"><b>{item.displayIndex})</b> Customer Name</span>
                                                        <span>:</span>
                                                        <span class="outlet-value">{item.Customer_Name__c}</span>
                                                    </div>
                                                    <div class="outlet-row">
                                                        <span class="outlet-label">Customer Type</span>
                                                        <span>:</span>
                                                        <span class="outlet-value">{item.primaryCustomerType}</span>
                                                    </div>
                                                    <div class="outlet-row">
                                                        <span class="outlet-label">SAP Code</span>
                                                        <span>:</span>
                                                        <span class="outlet-value">{item.primaryCustomerCode}</span>
                                                    </div>
                                                    <div class="outlet-row">
                                                        <span class="outlet-label">Customer Code</span>
                                                        <span>:</span>
                                                        <span class="outlet-value">{item.customerCode}</span>
                                                    </div>
                                                    <!--<template if:false={is_SSA_DSM}>
                                                        <div class="outlet-row">
                                                            <span class="outlet-label">Sales Channel</span>
                                                            <span>:</span>
                                                            <span class="outlet-value">{item.Chanel__c}</span>
                                                        </div>
                                                        <div class="outlet-row">
                                                            <span class="outlet-label">Order Type</span>
                                                            <span>:</span>
                                                            <span class="outlet-value">{item.Order_Type__c}</span>
                                                        </div>
                                                    </template>-->
                                                </div>
                                                <!--More-->
                                                <template lwc:if={assignPrimaryCustomers}>
                                                    <div class="right"  >
                                                        <svg class="outlet-icon" width="24" data-id={item.id} data-index={index}  onclick={openMenu} height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M12 5.92C12.2546 5.92 12.4988 5.81886 12.6789 5.63882C12.8589 5.45879 12.96 5.21461 12.96 4.96C12.96 4.70539 12.8589 4.46121 12.6789 4.28118C12.4988 4.10114 12.2546 4 12 4C11.7454 4 11.5013 4.10114 11.3212 4.28118C11.1412 4.46121 11.04 4.70539 11.04 4.96C11.04 5.21461 11.1412 5.45879 11.3212 5.63882C11.5013 5.81886 11.7454 5.92 12 5.92ZM12 12.96C12.2546 12.96 12.4988 12.8589 12.6789 12.6788C12.8589 12.4988 12.96 12.2546 12.96 12C12.96 11.7454 12.8589 11.5012 12.6789 11.3212C12.4988 11.1411 12.2546 11.04 12 11.04C11.7454 11.04 11.5013 11.1411 11.3212 11.3212C11.1412 11.5012 11.04 11.7454 11.04 12C11.04 12.2546 11.1412 12.4988 11.3212 12.6788C11.5013 12.8589 11.7454 12.96 12 12.96ZM12 20C12.2546 20 12.4988 19.8989 12.6789 19.7188C12.8589 19.5388 12.96 19.2946 12.96 19.04C12.96 18.7854 12.8589 18.5412 12.6789 18.3612C12.4988 18.1811 12.2546 18.08 12 18.08C11.7454 18.08 11.5013 18.1811 11.3212 18.3612C11.1412 18.5412 11.04 18.7854 11.04 19.04C11.04 19.2946 11.1412 19.5388 11.3212 19.7188C11.5013 19.8989 11.7454 20 12 20Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                        </svg>
                                                        <!-- Popup menu -->
                                                        <template lwc:if={item.openPopup}>
                                                            <div class="popup" id={index}>
                                                                <ul>
                                                                    <li onclick={handleOnclickMenu} data-name="Add" data-id={item.Id} data-index={index}>
                                                                        <i class="material-symbols-outlined">
                                                                            <lightning-icon 
                                                                                    icon-name="utility:add" 
                                                                                    size="x-small" 
                                                                                    alternative-text="Add"
                                                                                    class="invert-image" 
                                                                                    ></lightning-icon>
                                                                        </i>
                                                                        Add
                                                                    </li>
                                                                    <li onclick={handleOnclickMenu} data-name="Edit" data-id={item.Id} data-index={index}>
                                                                        <i class="material-icons">
                                                                            <lightning-icon 
                                                                                            icon-name="utility:edit" 
                                                                                            size="x-small" 
                                                                                            alternative-text="Edit"
                                                                                            class="invert-image"
                                                                                            >
                                                                            </lightning-icon>
                                                                        </i>
                                                                        Edit
                                                                    </li > 
                                                                    <template lwc:if={isShowDelete}>
                                                                        <li onclick={handleOnclickMenu} data-name="Delete" data-id={item.Id} data-index={index}>
                                                                            <i class="material-icons">
                                                                                <lightning-icon 
                                                                                                icon-name="utility:delete" 
                                                                                                size="x-small" 
                                                                                                alternative-text="Delete"
                                                                                                class="invert-image"
                                                                                                >
                                                                                </lightning-icon>
                                                                            </i>
                                                                            Delete
                                                                        </li >    
                                                                    </template>           
                                                                </ul>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template> 
                            </div>
                        </template>
                        <template lwc:else>
                            <template if:true={isUserDeactivated}>
                                <div style="text-align: center;padding-top:30px">
                                    <b>Primary customer assignments not found. This employee is currently deactivated.
                                         Please contact your administrator to activate the employee.</b>
                                </div>
                            </template>
                        </template>
                    </div>
                </template>
            </template>
            <!--Add/Edit From-->
            <template if:true={isModalOpen}>
                <div style="margin-bottom:160px">
                    <!-- Header -->
                    <div class="slds-p-vertical_small">
                        <template lwc:if={isDesktop}>
                            <div class='slds-grid slds-align_absolute-center slds-wrap'>
                                <!-- Title -->
                                <div class="slds-col slds-grow" style="padding-left:2px">
                                    <h1>
                                        <span class="slds-page-header__title slds-truncate" title={modalTitle}>
                                            {modalTitle}
                                        </span>
                                    </h1>
                                </div>
                                
                                <!-- Buttons (Desktop only) -->
                                <div class="slds-col slds-no-flex slds-m-left_small">
                                    <lightning-button
                                        variant="neutral"
                                        label="Cancel"
                                        onclick={closeModal}
                                        class="slds-m-right_x-small">
                                    </lightning-button>
                                    <lightning-button
                                        variant="brand"
                                        label="Save"
                                        onclick={handleSaveButtonClick}>
                                    </lightning-button>
                                </div>
                            </div>
                        </template>
                        <template lwc:else>
                            <div style ="text-align:center">
                                <h1>
                                    <span class="slds-page-header__title slds-truncate" title={modalTitle}>
                                        {modalTitle}
                                    </span>
                                </h1>
                            </div>
                        </template>
                    </div>
                    <!-- Form Fields -->
                    <div class="slds-card border">
                        <div class="slds-p-around_small slds-grid slds-wrap slds-gutters">
                            <!-- Executive Name -->
                            <div class={customClass}>
                                <lightning-input 
                                    label="Executive"
                                    type="text"
                                    value={dataItem.Executive_Name__c}
                                    disabled="true">
                                </lightning-input>
                            </div>
                            <!--TSE fields-->
                            <template if:false={is_SSA_DSM}>
                                <!--Sales Channel-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Sales Channel"
                                        data-id="customerAssignmentFields"
                                        name="Chanel__c"
                                        value={dataItem.Chanel__c}
                                        dropdown-alignment="auto"
                                        options={productMappingchannelOptions}
                                        message-when-value-missing="Select Channel"
                                        placeholder="Select option"
                                        required="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Teritory-->
                                <div class={customClass}>
                                    <div class="slds-m-right_xx-small slds-form-element">
                                        <div class="slds-form-element__control">
                                            <div class="slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click slds-is-open">
                                                <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right" role="none">
                                                    <lightning-input
                                                        label="Territory"
                                                        type="search"
                                                        name="Area_Name__c"
                                                        value={dataItem.Area_Name__c} 
                                                        read-only={isTerritoryReadOnly}
                                                        class="readonly-bordered"
                                                        data-id="customerAssignmentFields"
                                                        message-when-value-missing="Search Territory"
                                                        placeholder="Select Territory"
                                                        onchange={handleTerritorySearch}
                                                        required="true">
                                                    </lightning-input> 
                                                </div>
                                                <template lwc:if={isShowAreaValues}>
                                                    <div  class="slds-dropdown slds-dropdown_length-5 slds-dropdown_fluid" role="listbox" aria-label="Placeholder for Dropdown Items" tabindex="0" aria-busy="false">
                                                        <template for:each={searchedAreas} for:item="srch">
                                                            <ul key={srch.Id} class="slds-listbox slds-listbox_vertical" role="presentation" >
                                                                <li role="presentation" class="slds-listbox__item">
                                                                <div class="slds-media slds-listbox__option slds-listbox__option_plain slds-media_small" role="option" 
                                                                onclick={selectTerritory} data-id={srch.Id} data-name={srch.Name} >
                                                                    <lightning-icon 
                                                                        icon-name="standard:product_service_campaign_item" size="small">
                                                                    </lightning-icon>
                                                                    <span class="slds-media__figure slds-listbox__option-icon"></span>
                                                                    <span class="slds-media__body">
                                                                    <span class="slds-truncate" title={srch.Name}>
                                                                        <span>{srch.Name}</span>
                                                                    </span>
                                                                    </span>
                                                                </div>
                                                                </li>
                                                            </ul>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- Primary Customer -->
                            <div class={customClass}>
                                <div class="slds-m-right_xx-small slds-form-element">
                                    <div class="slds-form-element__control">
                                        <div class="slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click slds-is-open">
                                            <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right">
                                                <lightning-input
                                                    label="Primary Customer"
                                                    data-index={index}
                                                    data-id="customerAssignmentFields"
                                                    type="search"
                                                    read-only={isPrimaryCustoerReadOnly}
                                                    class="readonly-bordered"
                                                    value={dataItem.Customer_Name__c}
                                                    message-when-value-missing="Search Primary Customer"
                                                    placeholder="Search Primary Customer"
                                                    onchange={handlePrimarySearch}
                                                    required="true">
                                                </lightning-input>
                                            </div>

                                            <template lwc:if={isShowPrimaryCustomers}>
                                                <div class="slds-dropdown slds-dropdown_length-5 slds-dropdown_fluid" role="listbox">
                                                    <template for:each={searchedCustomers} for:item="srch">
                                                        <ul key={srch.customerId} class="slds-listbox slds-listbox_vertical">
                                                            <li role="presentation" class="slds-listbox__item">
                                                                <div class="slds-media slds-listbox__option slds-listbox__option_plain slds-media_small"
                                                                    role="option"
                                                                    onclick={selectPrimaryCustomer}
                                                                    data-name={srch.customerName}
                                                                    data-paytype={srch.paymentTypeFormula}
                                                                    data-index={index}
                                                                    data-id={srch.customerId}>
                                                                    <lightning-icon icon-name="standard:account" size="small"></lightning-icon>&nbsp;
                                                                    <span class="slds-media__figure slds-listbox__option-icon"></span>
                                                                    <span class="slds-media__body">
                                                                        <span class="user-info" title={srch.customerName}>
                                                                            <span>{srch.customerName}</span>
                                                                            <span>{srch.sapCode}</span>
                                                                        </span>
                                                                    </span>
                                                                
                                                                </div>
                                                            </li>
                                                        </ul>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!--TSE fields-->
                            <template if:false={is_SSA_DSM}>
                                <!--PDP Day-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="PDP Day"
                                        name="PDP_Day__c"
                                        value={dataItem.PDP_Day__c}
                                        dropdown-alignment="auto"
                                        options={pdpDayList}
                                        message-when-value-missing="Select PDP day"
                                        placeholder="Select option"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Parent Deport-->
                                <div class={customClass}>
                                    <lightning-combobox
                                    label="Sales Organization"
                                    data-id="customerAssignmentFields"
                                    name="Parent_Depot__c"
                                    value={dataItem.Parent_Depot__c}
                                    dropdown-alignment="auto"
                                    options={ParentDeportOptions}
                                    message-when-value-missing="Select Sales Organization"
                                    placeholder="Select option"
                                    required="true"
                                    onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Child Deport-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Delivery Plant"
                                        data-id="customerAssignmentFields" 
                                        name="Child_Depot__c"
                                        value={dataItem.Child_Depot__c}
                                        dropdown-alignment="auto"
                                        options={childDeportOptions}
                                        message-when-value-missing="Select Delivery Plant"
                                        placeholder="Select option"
                                        required="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Sales Office-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Sales Office"
                                        data-id="customerAssignmentFields"
                                        name="Sales_Office__c"
                                        value={dataItem.Sales_Office__c}
                                        dropdown-alignment="auto"
                                        options={salesOfficeList}
                                        message-when-value-missing="Select Sales Office"
                                        placeholder="Select option"
                                        required="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Division-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Division"
                                        data-id="customerAssignmentFields"
                                        name="Division__c"
                                        value={dataItem.Division__c}
                                        dropdown-alignment="auto"
                                        options={divisionList}
                                        message-when-value-missing="Select Division"
                                        placeholder="Select option"
                                        required="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Order Type-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Order Type"
                                        data-id="customerAssignmentFields"
                                        name="Order_Type__c"
                                        value={dataItem.Order_Type__c}
                                        dropdown-alignment="auto"
                                        options={orderTypeList}
                                        message-when-value-missing="Select Order Type"
                                        placeholder="Select option"
                                        required="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Distribution Channel-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Distribution Channel"
                                        data-id="customerAssignmentFields" 
                                        name="Distribution_Channel__c"
                                        value={dataItem.Distribution_Channel__c}
                                        dropdown-alignment="auto"
                                        options={distributonChannelList}
                                        message-when-value-missing="Select Distribution Channel"
                                        placeholder="Select option"
                                        required="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                             
                                <!--Payment Term-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Payment Term"
                                        data-id="customerAssignmentFields" 
                                        name="Payment_Term__c"
                                        value={dataItem.Payment_Term__c}
                                        dropdown-alignment="auto"
                                        options={paymemtTermList}
                                        message-when-value-missing="Select Payment Term"
                                        placeholder="Select option"
                                        required={isCreditPaytypeCustomer}
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Credit Description-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Credit Description"
                                        data-id="customerAssignmentFields" 
                                        name="Credit_Description__c"
                                        value={dataItem.Credit_Description__c}
                                        dropdown-alignment="auto"
                                        options={creditDescriptions}
                                        message-when-value-missing="Select Credit Description"
                                        placeholder="Select option"
                                        disabled="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                                <!--Inco Terms-->
                                <div class={customClass}>
                                    <lightning-combobox
                                        label="Inco Terms"
                                        data-id="customerAssignmentFields" 
                                        name="Inco_Terms__c"
                                        value={dataItem.Inco_Terms__c}
                                        dropdown-alignment="auto"
                                        options={incotermList}
                                        message-when-value-missing="Select Inco Terms"
                                        placeholder="Select option"
                                        required="true"
                                        onchange={handleInputProductMappingChange}>
                                    </lightning-combobox>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!-- Buttons (Mobile only, in a card) -->
                    <template if:false={isDesktop}>
                        <div class="slds-card border">
                            <div class="slds-grid slds-grid_align-center slds-gutters slds-p-around_small" >
                                <div class="slds-col">
                                    <lightning-button
                                        variant="neutral"
                                        label="Cancel"
                                        onclick={closeModal}>
                                    </lightning-button>
                                </div>
                                <div class="slds-col">
                                    <lightning-button
                                        variant="brand"
                                        label="Save"
                                        onclick={handleSaveButtonClick}>
                                    </lightning-button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
                         
            <!-- Delete Confirmation Modal -->
            <template if:true={isDeleteModalOpen}>
                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container">
                        <header class="slds-modal__header" style="color: black;">
                            <h2 id="modal-heading-01" class="slds-modal__title slds-hyphenate">Delete Assignment</h2>
                        </header>
                        
                        <div class="slds-modal__content slds-p-around_medium centeralign" >
                            Are you sure you want to delete this Assignment?
                        </div>
                        
                        <!-- Modal Footer -->
                        <footer class="slds-modal__footer">
                            <button class="slds-button slds-button_neutral" onclick={handleDeleteCancel}>No</button>
                            <button class="slds-button slds-button_brand" onclick={deleteassignment}>Yes</button>
                        </footer>
                    
                    </div>
                </section>
                    <div class="slds-backdrop slds-backdrop_open"></div>
            </template>
        </template>
    </div>

</template>