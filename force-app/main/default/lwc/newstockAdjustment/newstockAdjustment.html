<template>
    <template lwc:if={isPageLoaded}>
        <div style="margin:40px">
            <c-loading-screen></c-loading-screen>
        </div>
    </template>
    <template lwc:else>
        <div class="orders" id="SecondaryReturnLayout">

            <!-- HEADER -->
            <div class="order-head slds-grid">
                <div class="slds-col slds-size_1-of-2">
                    <h3 class="order-title">New Stock Adjustment</h3>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-text-align_right">
                    <button class="actionButton" onclick={handleSave}>Save</button>
                    <button class="actionButton1" onclick={handleCancel}>Cancel</button>
                </div>
            </div>

            <!-- TABLE -->
            <div class="slds-box table-container">
                <!-- Grid Table Section -->
                <div class="slds-box" style="padding-bottom:250px">
                    <!-- Table Header -->
                    <div class="slds-grid slds-gutters slds-p-around_small slds-theme_shade"
                        style="font-weight: bold; border-bottom: 2px solid #dddbda; align-items: center;">
                        <div class="slds-col" style="flex: 0 0 5%; max-width: 5%; min-width: 0;">S.No.</div>
                        <div class="slds-col" style="flex: 0 0 20%; max-width: 20%; min-width: 0;">Adjustment Type</div>
                        <div class="slds-col" style="flex: 0 0 25%; max-width: 25%; min-width: 0;">Product</div>
                        <div class="slds-col" style="flex: 0 0 10%; max-width: 10%; min-width: 0;">Available Quantity
                        </div>
                        <div class="slds-col" style="flex: 0 0 10%; max-width: 10%; min-width: 0;">Quantity</div>
                        <div class="slds-col" style="flex: 0 0 25%; max-width: 25%; min-width: 0;">Reason</div>
                        <div class="slds-col" style="flex: 0 0 5%; max-width: 5%; min-width: 0; text-align: right;">
                            Actions</div>
                    </div> <!-- Table Rows --> <template for:each={stockAdjustments} for:item="item" for:index="index">
                        <div key={item.id} class="slds-grid slds-gutters slds-p-around_small slds-border_bottom"
                            style="align-items: center;">
                            <div class="slds-col" style="flex: 0 0 5%; max-width: 5%; min-width: 0;"> {item.rowIndex}
                            </div> <!-- Adjustment Type -->
                            <div class="slds-col" style="flex: 0 0 20%; max-width: 20%; min-width: 0; ">
                                <div style="width: 100%;">
                                    <lightning-combobox variant="label-hidden" value={item.adjustmentType} required
                                        options={adjustmentTypeOptions} data-index={index}
                                        onchange={handleAdjustmentTypeChange} placeholder="Select reason..."
                                        class="reason-combobox"> </lightning-combobox>
                                </div>
                            </div> <!-- Product Search -->
                            <div class="slds-col"
                                style="flex: 0 0 25%; max-width: 25%; min-width: 0; position: relative;">
                                <lightning-input variant="label-hidden" value={item.productName} type="search" required
                                    data-index={index} onfocus={handleProductFocus} onchange={handleProductSearch}
                                    disabled={item.disableProductSelection} placeholder="Search product...">
                                </lightning-input> <template if:true={item.showSuggestions}>
                                    <div class="suggestion-box" role="listbox"
                                        style="max-height: 200px; overflow-y: auto;">
                                        <ul class="slds-listbox slds-listbox_vertical"> <template
                                                for:each={item.filteredProducts} for:item="prod">
                                                <li key={prod.value} class="slds-listbox__item">
                                                    <div class="slds-media slds-listbox__option slds-listbox__option_plain slds-media_small"
                                                        onclick={selectProduct} data-index={index} data-id={prod.Product__c}
                                                        data-saleableqty={prod.Available_Saleable_Quantity__c} 
                                                        data-nonsaleableqty={prod.Available_Nonsaleable_Quantity__c}
                                                        style="cursor: pointer;">
                                                        <span class="slds-media__figure"> <lightning-icon icon-name="standard:product" size="small"></lightning-icon> </span>
                                                        <span class="slds-media__body"> <span class="slds-truncate" title={prod.Product_Name__c}>{prod.Product_Name__c}</span>
                                                        </span>
                                                    </div>
                                                </li>
                                            </template> </ul>
                                    </div>
                                </template>
                            </div>
                            <!--Available Quantity -->
                            <div class="slds-col" style="flex: 0 0 10%; max-width: 10%; min-width: 0;">
                                <lightning-input variant="label-hidden" type="number" value={item.availablequantity}
                                    disabled placeholder="Qty"></lightning-input>
                            </div> <!-- Quantity -->
                            <div class="slds-col" style="flex: 0 0 10%; max-width: 10%; min-width: 0;">
                                <lightning-input variant="label-hidden" type="number" value={item.quantity}
                                    disabled={item.disableProductSelection} data-index={index} required
                                    onchange={handleQuantityChange} placeholder="Qty">
                                </lightning-input>
                            </div> <!-- Reason -->
                            <div class="slds-col" style="flex: 0 0 25%; max-width: 25%; min-width: 0;">
                                <lightning-input type="text" variant="label-hidden" value={item.reason}
                                    data-index={index} required onchange={handleReasonChange} placeholder="Enter reason">
                                </lightning-input>
                            </div> <!-- Actions -->
                            <div class="slds-col" style="flex: 0 0 5%; max-width: 5%; min-width: 0; text-align: right;">
                                <lightning-button-icon icon-name="utility:delete" alternative-text="Remove Row"
                                    onclick={removeRow} variant="bare" data-index={index} class="slds-m-right_xx-small">
                                </lightning-button-icon>
                                <lightning-button-icon icon-name="utility:add" alternative-text="Add Row"
                                    onclick={addRow} variant="bare" data-index={index}> </lightning-button-icon>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <c-custom-toast auto-close-time="8000"></c-custom-toast>
</template>