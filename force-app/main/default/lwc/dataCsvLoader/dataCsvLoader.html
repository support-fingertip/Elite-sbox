<template>


    <div slot="header" 
         style="background: linear-gradient(to right, #4CAF50, #81C784); 
                color: white; 
                font-size: 20px; 
                font-weight: bold; 
                padding: 10px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;">
        
        <!-- Header Text -->
        Data Uploader
        
        <!-- Back Button -->
        <lightning-button
            label="Back"
            icon-name="utility:back"
            icon-position="right"
            title="Back"
            style="font-size: 14px;"
            variant="brand"
            onclick={handleUploadBack}
            disabled={isLoading}>
        </lightning-button>
    </div>
    <div  style="border-radius: 10px; overflow: hidden; min-height: 500px; padding-bottom: 400px;
    background: linear-gradient(to bottom, #f0f8f0, #ffffff); ">
    
     
 

    

        <div class="slds-p-around_medium">
            <!-- Object Selection -->
            <lightning-combobox
                label="Select Salesforce Object"
                value={selectedObject}
                options={objectOptions}
                onchange={handleObjectChange}
                class="slds-m-bottom_medium">
            </lightning-combobox>

            <!-- File Upload -->
            <lightning-file-upload
                label="Upload CSV File"
                accept={acceptedFormats}
                onuploadfinished={handleUploadFinished}
                disabled={isUploadDisabled}
                class="slds-m-bottom_medium">
            </lightning-file-upload>

            <!-- Field Mapping Section -->
            <template if:true={showMapping}>
                <div class="slds-box slds-theme_default slds-m-bottom_medium">
                    <h2
                        class="slds-text-heading_medium slds-m-bottom_medium">Field
                        Mapping</h2>

                    <!-- Field Mapping -->
                    <div class="custom-grid">
    <template for:each={fieldMappingOptions} for:item="mapping">
      <div key={mapping.header} class="custom-col">
        <lightning-combobox
            class={mapping.cssClass}
            label={mapping.header}
            placeholder="Select Field"
            options={objectFields}
            value={mapping.value}
            data-header={mapping.header}
            onchange={handleFieldMapping}>
        </lightning-combobox>
      </div>
    </template>
  </div>

                    <!-- Upload Button -->
                    <div class="slds-m-top_medium slds-text-align_center">
                       <lightning-button
       label="Upload Data"
       variant="brand"
       disabled={isUploadDisabled}
       onclick={handleUpload}>
</lightning-button>
                    </div>

                    <!-- CSV Preview -->
                    <div class="slds-m-bottom_medium">
                        <h3
                            class="slds-text-heading_small slds-m-bottom_small">CSV
                            Preview (First 5 rows)</h3>
                        <div class="slds-scrollable_x">
                            <table
                                class="slds-table slds-table_bordered slds-table_cell-buffer">
                                <thead>
                                    <tr class="slds-text-title_caps">
                                        <template for:each={csvHeaders}
                                            for:item="header">
                                            <th key={header}
                                                scope="col">{header}</th>
                                        </template>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={previewRows}
                                        for:item="row">
                                        <tr key={row.id}>
                                            <template for:each={row.values}
                                                for:item="cell">
                                                <td
                                                    key={cell.key}>{cell.value}</td>
                                            </template>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </template>

            <!-- Loading Spinner -->
            <template if:true={isLoading}>
                <lightning-spinner alternative-text="Loading"
                    size="medium"></lightning-spinner>
            </template>

            <!-- Results Section -->
            <template if:true={showResults}>
                <div class="slds-box slds-theme_default">
                    <div class="slds-text-heading_medium slds-m-bottom_medium">
                        Upload Results
                    </div>

                    <template if:true={hasErrors}>
                        <div class="slds-m-top_medium">
                            <div
                                class="slds-text-heading_small slds-m-bottom_small">Errors:</div>
                            <template for:each={errors} for:item="error">
                                <div key={error}
                                    class="slds-text-color_error">{error}</div>
                            </template>
                        </div>
                    </template>

                    <!-- All Records Table with Filter -->
                    <template if:true={hasRecords}>
                        <div class="slds-m-top_medium">
                            <!-- Stats, Filter and Download Section -->
                            <div
                                class="slds-grid slds-grid_vertical-align-end slds-m-bottom_medium filter-section slds-p-around_medium">
                                <!-- Success and Error Stats -->
                                <div class="slds-col slds-size_2-of-6">
                                    <div class="slds-grid slds-gutters">
                                        <div class="slds-col">
                                            <div
                                                class="stats-label">Success</div>
                                            <div
                                                class="slds-text-heading_medium slds-text-color_success">{successCount}</div>
                                        </div>
                                        <div class="slds-col">
                                            <div
                                                class="stats-label">Errors</div>
                                            <div
                                                class="slds-text-heading_medium slds-text-color_error">{errorCount}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Filter -->
                                <div class="slds-col slds-size_2-of-6">
                                    <lightning-combobox
                                        name="statusFilter"
                                        label="Filter Records"
                                        value={selectedStatusFilter}
                                        options={statusFilterOptions}
                                        onchange={handleStatusFilterChange}>
                                    </lightning-combobox>
                                </div>

                                <!-- Download Button -->
                                <div
                                    class="slds-col slds-size_2-of-6 slds-text-align_right">
                                    <div class="stats-label">Total Records:
                                        {filteredRecords.length}</div>
                                    <lightning-button
                                        label={downloadButtonLabel}
                                        icon-name="utility:download"
                                        icon-position="right"
                                        onclick={downloadFilteredRecords}
                                        variant={downloadButtonVariant}>
                                    </lightning-button>
                                </div>
                            </div>

                            <!-- Results Table -->
                            <div
                                class="slds-box slds-theme_default table-container">
                                <div
                                    class="slds-text-heading_small slds-m-bottom_small">
                                    Upload Results Details
                                </div>
                                <div class="slds-scrollable_x">
                                    <table
                                        class="slds-table slds-table_bordered slds-table_cell-buffer slds-table_striped">
                                        <thead>
                                            <tr class="slds-line-height_reset">
                                                <th scope="col">Row</th>
                                                <template for:each={csvHeaders}
                                                    for:item="header">
                                                    <th key={header}
                                                        scope="col">{header}</th>
                                                </template>
                                                <th scope="col">Upload
                                                    Status</th>
                                                <th scope="col">Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template for:each={filteredRecords}
                                                for:item="record">
                                                <tr key={record.rowIndex}>
                                                    <td>{record.rowIndex}</td>
                                                    <template
                                                        for:each={record.cellValues}
                                                        for:item="cell">
                                                        <td
                                                            key={cell.header}>{cell.value}</td>
                                                    </template>
                                                    <td>
                                                        <lightning-badge
                                                            label={record.status}
                                                            class={record.status}>
                                                        </lightning-badge>
                                                    </td>
                                                    <td>
                                                        <template
                                                            if:true={record.hasErrorMessages}>
                                                            <template
                                                                for:each={record.errorMessages}
                                                                for:item="error">
                                                                <div key={error}
                                                                    class="slds-text-color_error">{error}</div>
                                                            </template>
                                                        </template>
                                                        <template
                                                            if:true={record.recordId}>
                                                            <div
                                                                class="record-id">ID:
                                                                {record.recordId}</div>
                                                        </template>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
 <c-custom-toast auto-close-time="8000"></c-custom-toast> <!-- Added custom toast at the bottom of the page -->
</template>